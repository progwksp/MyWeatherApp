<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Weather App</title>
<style>
  body {
    background-color: whitesmoke;
    font-family: "Space Grotesk", Arial, sans-serif;
  }
  #header {
    border: 1px solid lavender;
    border-radius: 1em;
    background-color: white;
    padding: 1em 1.5em 1em 1.5em;
  }
  #show {
  	display: flex;
  	flex-wrap: wrap;
  	justify-content: space-around;
  }
  #show > div {
  	width: 8em;
  	height: 8em;
  	border-radius: 1em;
  	margin: 0.5em;
    padding: 0.5em;
    background-color: lightblue;
  }
  div > p {
  	text-align: center;
    font-size: 1em;
  }
  p:first-of-type {
  	margin-top: 32px;
  }
  .btn {
  	display: inline-block;
  	float: right;
  	margin: 1px;
  }
  .winfo {
    padding-right: 1em;
  }
  span {
    font-size: 2em;
  }
  #title {
    font-size: 2.5em;
    width: 6em;
    display: inline-block;
    margin: 0.5em 0 1em 0;
  }
  #area {
    font-size: 1em;
    margin-bottom: 1em;
  }
  @media only screen and (max-width: 480px) {
    #title {
      display: block;
      margin: 0.5em 0 0.25em 0;
    }
    #icon {
      display: block;
      margin-bottom: 0.25em;
    }
    span {
      font-size: 1.5em;
    }
    .winfo {
      padding-right: 0.7em;
    }
    #area {
      margin-top: 1.5em;
      text-align: center;
    }
  }

</style>
</head>
<body>
  <div id="header"></div>
  <div id="show"></div>
  <script>

    // get the geolocation - latitude and longitude
    function getloc() {  
      return new Promise((resolve, reject) => {
        function success(position) {
          let data = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          resolve(data);
        }
        function error() {
          reject("Unable to retrieve your location");
        }
        navigator.geolocation.getCurrentPosition(success, error);
      });
    }
    
    // get the current district location
    function getdistrict(pos) {
      return fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.lat}&longitude=${pos.lng}&localityLanguage=en`,
            {mode: 'cors'})
      .then(response => response.json())
      .catch(err => console.log(err));
    }
    
    // get the weather data from Observatory
  	async function getObData() {
      return fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=en", {mode: 'cors'})
      .then(response => response.json())
      .catch(err => console.log(err));
    }
    
    async function main() {
      let pos = await getloc(); //wait for getting current geolocation
      let addr = await getdistrict(pos); //wait for getting district info

      let output = document.getElementById('header');
      let title = document.createElement('div');
      title.id = 'title';
      title.innerHTML = 'Weather in Hong Kong';
      output.append(title);
      

      
      let Odata = await getObData();
      
      let iconidx = Odata.icon[0];
      let icon = document.createElement('img');
      icon.src = 'https://rss.weather.gov.hk/img/pic'+iconidx+'.png';
      icon.id = 'icon';
      icon.setAttribute('class', 'winfo');
      output.append(icon);
      
      let tempBlk = document.createElement('span');
      tempBlk.setAttribute('class', 'winfo');
      let tempIcon = document.createElement('img');
      tempIcon.src = 'thermometer-48.png';
      tempBlk.append(tempIcon);
      let tempData = Odata.temperature.data[1].value;
      tempBlk.innerHTML += tempData+' <small>°C</small>';
      output.append(tempBlk);
      
      let humBlk = document.createElement('span');
      humBlk.setAttribute('class', 'winfo');
      let humIcon = document.createElement('img');
      humIcon.src = 'drop-48.png';
      humBlk.append(humIcon);      
      let humData = Odata.humidity.data[0].value;
      humBlk.innerHTML += humData+'<small>%</small>';
      output.append(humBlk);
      
      let rainBlk = document.createElement('span');
      rainBlk.setAttribute('class', 'winfo');      
      let rainIcon = document.createElement('img');
      rainIcon.src = 'rain-48.png';
      rainBlk.append(rainIcon);
      Odata.rainfall.data[0].place = 'central and western district';
      for (place of Odata.rainfall.data) {
        let district = place.place.toLowerCase();
        if (!district.includes('district'))
          district = district + ' district';
        if (district == addr.locality.toLowerCase()) {
          let rainData = place.max;
          rainBlk.innerHTML += rainData+' <small>mm</small>';
          output.append(rainBlk);
        }
      }

      let area = document.createElement('div');
      area.id = 'area';
      area.innerHTML = 'District: '+addr.locality.slice(0,addr.locality.length-9);
      output.append(area);      
      
      let view = document.getElementById("show");
      let item = 0;
      for (loc of Odata.temperature.data) {
      	let elm = document.createElement('div');
        elm.id = 'blk'+item;
        item++;
        elm.innerHTML = `<img class='btn' src='cancel-24.ico'><p>${loc.place}</p> <p>${loc.value} °C</p>`;
        view.append(elm);
        btns = document.querySelectorAll('.btn');
        for (let btn of btns) {
          btn.addEventListener('click', (event) => {
            let parent = event.target.parentNode;
            parent.style.display = 'none';
          });
        }
      }      
    }

    
    main();

  </script>
</body>
</html?

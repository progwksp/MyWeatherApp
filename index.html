<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Weather App</title>
<style>
  body {
    background-color: whitesmoke;
    font-family: "Space Grotesk", Arial, sans-serif;
  }
  #header {
    width: 800px;
    border: 1px solid lavender;
    border-radius: 1em;
    background-color: white;
    padding: 1em 1.5em 1em 1.5em;
  }
  #show {
    width: 850px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
  }
  .block {
    width: 8em;
    height: 8em;
    border-radius: 1em;
    margin: 0.5em;
    padding: 0.5em;
    background-color: lightblue;
  }
  div > p {
    text-align: center;
    font-size: 1em;
  }
  p:first-of-type {
    margin-top: 32px;
  }
  .btn {
    display: inline-block;
    float: right;
    margin: 1px;
  }
  .winfo {
    padding-right: 1em;
    font-size: 2em;
  }
  #title {
    font-size: 2.5em;
    width: 6em;
    display: inline-block;
    margin: 0.5em 0 0.5em 0;
  }
  #district {
    width: 800px;
    font-size: 1em;
    font-weight: bold;
    padding: 1em;
  }
  @media only screen and (max-width: 800px) {
    #header, #show, #district {
      width: 100%;
    }
    #title {
      display: block;
      margin: 0.5em 0 0.25em 0;
    }
    #icon {
      display: block;
      margin-bottom: 0.25em;
    }
    .winfo {
      padding-right: 0.7em;
      font-size: 1.5em;
    }
    #district {
      text-align: center;
      padding: 0.6em;
    }
  }

</style>
</head>
<body>
  <div id="header"></div>
  <div id="district"></div>
  <div id="show"></div>
  <script>

    // get the geolocation - latitude and longitude
    function getloc() {  
      return new Promise((resolve, reject) => {
        function success(position) {
          let data = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          resolve(data);
        }
        function error() {
          reject("Unable to retrieve your location");
        }
        navigator.geolocation.getCurrentPosition(success, error);
      });
    }
    
    // get the current district location
    function getdistrict(pos) {
      return fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.lat}&longitude=${pos.lng}&localityLanguage=en`,
            {mode: 'cors'})
      .then(response => response.json())
      .catch(err => console.log(err));
    }
    
    // get the weather data from Observatory
  	async function getObData() {
      return fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=en", {mode: 'cors'})
      .then(response => response.json())
      .catch(err => console.log(err));
    }
    
    async function init() {
      let pos = await getloc(); //wait for getting current geolocation
      let addr = await getdistrict(pos); //wait for getting district info

      //display the header section
      let output = document.getElementById('header');
      //display the title
      let title = document.createElement('div');
      title.id = 'title';
      title.innerHTML = 'Weather in Hong Kong';
      output.append(title);
            
      let Odata = await getObData(); //wait for weather data
      
      //display the weather icon
      let iconidx = Odata.icon[0];
      let icon = document.createElement('img');
      icon.src = 'https://rss.weather.gov.hk/img/pic'+iconidx+'.png';
      icon.id = 'icon';
      icon.setAttribute('class', 'winfo');
      output.append(icon);
      
      //display the temperature info
      let tempBlk = document.createElement('span');
      tempBlk.setAttribute('class', 'winfo');
      let tempIcon = "<img src='thermometer-48.png'>";
      let tempData = Odata.temperature.data[1].value;
      tempBlk.innerHTML = tempIcon + "<span id='temp'>" + tempData + "</span> <small>°C</small>";
      output.append(tempBlk);
      
      //display the humidity info
      let humBlk = document.createElement('span');
      humBlk.setAttribute('class', 'winfo');
      let humIcon = "<img src='drop-48.png'>";
      let humData = Odata.humidity.data[0].value;
      humBlk.innerHTML = humIcon + "<span id='humidity'>" + humData + "</span><small>%</small>";
      output.append(humBlk);
      
      //display the rainfall info
      let rainBlk = document.createElement('span');
      rainBlk.setAttribute('class', 'winfo');      
      let rainIcon = "<img src='rain-48.png'>";
      rainBlk.innerHTML = rainIcon + "<span id='rain'>0 </span><small>mm</small>";
      output.append(rainBlk);      
      Odata.rainfall.data[0].place = 'central and western district';
      for (place of Odata.rainfall.data) {
        let district = place.place.toLowerCase();
        if (!district.includes('district'))
          district = district + ' district';
        if (district == addr.locality.toLowerCase()) {
          let rainData = place.max;
          let rain = document.getElementById('rain');
          rain.innerText = rainData;
        }
      }

      //display the district info
      let area = document.getElementById('district');
      area.innerText = 'Current District: '+addr.locality.slice(0,addr.locality.length-9);     
      
      //show the temperature data of different locations
      let view = document.getElementById("show");
      for (loc of Odata.temperature.data) {
        let elm = document.createElement('div');
        elm.setAttribute('class', 'block');
        elm.innerHTML = "<img class='btn' src='cancel-24.ico'><p>" + loc.place + "</p> <p>" + loc.value + " °C</p>";
        view.append(elm);
      }
      
      //add event handler to each cross button
      btns = document.querySelectorAll('.btn');
      for (let btn of btns) {
        btn.addEventListener('click', (event) => {
          let parent = event.target.parentNode;
          parent.style.display = 'none';
        });
      }
    }
    
    async function mainloop() {
      console.log("Mainloop");
      let pos = await getloc(); //wait for getting current geolocation
      let addr = await getdistrict(pos); //wait for getting district info
      let Odata = await getObData(); //wait for weather data
      
      //update weather icon
      let icon = document.getElementById('icon');
      let iconidx = Odata.icon[0];
      icon.src = 'https://rss.weather.gov.hk/img/pic'+iconidx+'.png';
      
      //update temperature info
      let temp = document.getElementById('temp');
      let tempData = Odata.temperature.data[1].value;
      temp.innerText = tempData;
      
      //update humidity info
      let humidity = document.getElementById('humidity');
      let humData = Odata.humidity.data[0].value;
      humidity.innerText = humData;
      
      //update rainfall info
      Odata.rainfall.data[0].place = 'central and western district';
      for (place of Odata.rainfall.data) {
        let district = place.place.toLowerCase();
        if (!district.includes('district'))
          district = district + ' district';
        if (district == addr.locality.toLowerCase()) {
          let rainData = place.max;
          let rain = document.getElementById('rain');
          rain.innerText = rainData;
        }
      }
      
      //update district 
      let area = document.getElementById('district');
      area.innerText = 'District: '+addr.locality.slice(0,addr.locality.length-9);
      
      //update temperature data of different locations
      //remove existing blocks first
      let blocks = document.querySelectorAll('.block');
      for (blk of blocks) {
        blk.remove();
      }
      //show the temperature data 
      let view = document.getElementById("show");
      for (loc of Odata.temperature.data) {
        let elm = document.createElement('div');
        elm.setAttribute('class', 'block');
        elm.innerHTML = "<img class='btn' src='cancel-24.ico'><p>" + loc.place + "</p> <p>" + loc.value + " °C</p>";
        view.append(elm);
      }
      //add event handler to each cross button
      btns = document.querySelectorAll('.btn');
      for (let btn of btns) {
        btn.addEventListener('click', (event) => {
          let parent = event.target.parentNode;
          parent.style.display = 'none';
        });
      }
    }
    
    init();
    
    window.setTimeout(mainloop, 15000);

  </script>
</body>
</html>
